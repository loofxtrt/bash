#!/usr/bin/env bash
# cria um .md de um sonho nulo ou com conteÃºdo no obsidian

source /mnt/seagate/bash/internal/config.sh

year=$(date +"%Y") # obtÃ©m sÃ³ o ano atual
current_dream_journal=$OBSIDIAN_VAULTS/$VAULT_NAME_DREAMS/dream-log/$year
dream_journal_relative=/dream-log/$year

today=$(date +"%Y-%m-%d") # obtÃ©m a data atual e formata ela pra iso 8601
already_regisred=false # declara se o sonho de hoje jÃ¡ foi registrado ou nÃ£o (Ã© uma string, nÃ£o um boolean de verdade) 

for md_file in $current_dream_journal/*.md; do
    # basename retorna sÃ³ o nome do arquivo em vez do path completo
    file_name=$(basename "$md_file")

    # corta o nome do arquivo de 0 atÃ© 10, que Ã© a quantidade que o formato de data em iso tem
    # assim, o nome do arquivo Ã© desconsiderado e apenas a data permanece
    date_on_name=${file_name:0:10}
    
    # sinalizar caso um sonho com a mesma data jÃ¡ exista
    if [[ $date_on_name == $today ]]; then
        already_regisred=true
        break
    fi
done

if [[ $already_regisred != true ]]; then
    # obter o tÃ­tulo do sonho caso ele seja passado com -t ou --title
    TITLE=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -t|--title)
                TITLE="$2"
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done

    # se o tÃ­tulo tiver caracteres nÃ£o suportados, sai do script indicando erro (exit 1)
    if [[ "$TITLE" =~ [^a-zA-Z0-9_-] ]]; then
        echo "âš ï¸ o tÃ­tulo contÃ©m espaÃ§os ou caracteres especiais"
        exit 1
    fi

    # definir o nome final do arquivo markdown
    # se o title nÃ£o for nulo, atribui ele a nota, se nÃ£o, nomeia ela como null
    if [[ -n "$TITLE" ]]; then
        entry_name=$today"_"$TITLE".md"
    else
        entry_name=$today"_null.md"
    fi

    # registar o sonho no path final
    > $current_dream_journal/$entry_name
    echo "ðŸŒ’ sonho anotado com sucesso"
    echo $current_dream_journal/$entry_name

    # abrir o obsidian pra editar a nota caso ele tenha tÃ­tulo
    if [[ -n "$TITLE" ]]; then
        echo "ðŸª« a nota possui um tÃ­tulo. abrindo o obsidian..."
        xdg-open "obsidian://open?vault=$NAME_VAULT_DREAMS&file=$dream_journal_relative/$entry_name"
    fi
else
    echo "ðŸ’‰ o sonho de hoje jÃ¡ foi anotado"
fi